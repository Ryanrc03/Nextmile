# Nextmile 项目迁移部署 - 快速开始 🚀

## 📦 你将得到什么？

一套完整的自动化部署系统，让你能够：
- ✅ **一键部署** 到新的 AWS EC2 服务器
- ✅ **无缝迁移** 从旧服务器到新服务器
- ✅ **自动配置** SSL 证书、Nginx、数据库等
- ✅ **快速验证** 部署状态

## 🎯 三种部署方式

### 方式 1️⃣: 最快部署（推荐新服务器）

**适合**: 全新部署，不需要迁移数据

```bash
# 登录到新服务器
ssh -i your-key.pem ec2-user@<新服务器IP>

# 克隆项目
git clone https://github.com/Ryanrc03/Nextmile.git
cd Nextmile

# 一键部署（替换成你的域名和邮箱）
./scripts/deploy_to_new_server.sh \
  --domain nextmile.space \
  --email admin@nextmile.space
```

**等待 10-15 分钟，完成！** 🎉

---

### 方式 2️⃣: 完整迁移（推荐有旧数据）

**适合**: 从旧服务器迁移到新服务器，需要保留数据

#### 步骤 1: 在旧服务器备份数据

```bash
# SSH 登录旧服务器
ssh -i your-key.pem ec2-user@<旧服务器IP>

# 进入项目目录
cd /home/ec2-user/Nextmile

# 运行备份脚本
./scripts/backup_before_migration.sh
# 输入数据库密码

# 记下备份文件名，类似: migration_backup_20251008_120000.tar.gz
```

#### 步骤 2: 下载备份到本地

```bash
# 在本地电脑运行
scp -i your-key.pem ec2-user@<旧服务器IP>:~/migration_backup_*.tar.gz ./
```

#### 步骤 3: 在新服务器部署

```bash
# SSH 登录新服务器
ssh -i your-key.pem ec2-user@<新服务器IP>

# 克隆项目
git clone https://github.com/Ryanrc03/Nextmile.git
cd Nextmile

# 一键部署
./scripts/deploy_to_new_server.sh \
  --domain nextmile.space \
  --email admin@nextmile.space
```

#### 步骤 4: 上传并导入数据

```bash
# 上传备份到新服务器（在本地电脑运行）
scp -i your-key.pem migration_backup_*.tar.gz ec2-user@<新服务器IP>:~/

# 在新服务器上解压
ssh -i your-key.pem ec2-user@<新服务器IP>
cd ~
tar -xzf migration_backup_*.tar.gz
cd migration_backup_*

# 导入数据库
mysql -u nextmile_user -p nextmile_db < database.sql
# 输入数据库密码（默认在部署时设置）

# 恢复上传文件
tar -xzf uploads.tar.gz -C /home/ec2-user/Nextmile/public/

# 重启服务
pm2 restart all
```

**完成！** 🎉

---

### 方式 3️⃣: 手动部署（推荐高级用户）

**适合**: 需要完全控制部署过程，或自动脚本不适合你的环境

参考详细文档: [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md)

---

## 📋 部署后必做的事

### 1. 配置 DNS

在你的域名注册商（阿里云、腾讯云、GoDaddy等）：

1. 添加 A 记录
   - 主机记录: `@`
   - 记录类型: `A`
   - 记录值: `<新服务器的公网IP>`
   - TTL: `600`

2. 添加 www 子域名（可选）
   - 主机记录: `www`
   - 记录类型: `CNAME`
   - 记录值: `你的域名.com`
   - TTL: `600`

等待 5-30 分钟让 DNS 生效。

### 2. 配置 AWS 安全组

在 AWS EC2 控制台：

1. 找到你的 EC2 实例
2. 点击"安全组"
3. 编辑"入站规则"，添加：
   - HTTP (80): 源 `0.0.0.0/0`
   - HTTPS (443): 源 `0.0.0.0/0`
   - SSH (22): 源 `你的IP地址/32` （限制访问更安全）

### 3. 检查部署状态

```bash
# 运行状态检查脚本
cd /home/ec2-user/Nextmile
./scripts/check_deployment.sh
```

### 4. 配置环境变量（重要！）

```bash
cd /home/ec2-user/Nextmile
nano .env.production
```

**必须修改的配置**:

```bash
# 修改为你的实际配置
NEXT_PUBLIC_API_URL=https://你的域名.com
DATABASE_PASSWORD=设置一个强密码
OPENAI_API_KEY=你的OpenAI密钥（如果使用AI功能）

# 如果使用邮件功能
SMTP_HOST=smtp.gmail.com
SMTP_USER=你的邮箱@gmail.com
SMTP_PASSWORD=应用专用密码
```

**保存后重启服务**:
```bash
pm2 restart all
```

### 5. 测试网站

1. 打开浏览器访问: `https://你的域名.com`
2. 检查所有功能是否正常
3. 测试 AI 聊天功能
4. 测试表单提交

---

## 🔧 常用管理命令

### 查看服务状态
```bash
pm2 status
```

### 查看日志
```bash
# 查看所有日志
pm2 logs

# 查看特定服务
pm2 logs nextmile-api
pm2 logs nextmile-frontend
```

### 重启服务
```bash
# 重启所有服务
pm2 restart all

# 重启特定服务
pm2 restart nextmile-api
```

### 停止服务
```bash
pm2 stop all
```

### 检查 Nginx
```bash
# 检查配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

---

## 🐛 遇到问题？

### 问题 1: SSL 证书获取失败

**原因**: DNS 还没有生效

**解决**:
```bash
# 检查 DNS 是否生效
dig 你的域名.com

# 等待 DNS 生效后手动获取证书
sudo certbot --nginx -d 你的域名.com -d www.你的域名.com
```

### 问题 2: 网站无法访问

**检查清单**:
```bash
# 1. 检查服务是否运行
pm2 status

# 2. 检查端口是否监听
sudo netstat -tlnp | grep -E ':(80|443|3000|8000)'

# 3. 检查防火墙
sudo firewall-cmd --list-all

# 4. 检查 AWS 安全组
# 在 AWS 控制台检查
```

### 问题 3: 数据库连接失败

```bash
# 检查数据库服务
sudo systemctl status mysqld

# 测试数据库连接
mysql -u nextmile_user -p nextmile_db

# 检查数据库配置
cat .env.production | grep DATABASE
```

### 问题 4: 前端或后端启动失败

```bash
# 查看详细日志
pm2 logs nextmile-frontend --lines 100
pm2 logs nextmile-api --lines 100

# 检查端口是否被占用
sudo lsof -i :3000
sudo lsof -i :8000

# 手动启动测试
cd Frontend
npm start

cd ../chatbot
python3 api_server.py
```

---

## 📚 详细文档

| 文档 | 说明 |
|------|------|
| [DEPLOYMENT_QUICK_REFERENCE.txt](./DEPLOYMENT_QUICK_REFERENCE.txt) | 命令速查表 |
| [DEPLOYMENT_SCRIPTS_GUIDE.md](./DEPLOYMENT_SCRIPTS_GUIDE.md) | 脚本详细指南 |
| [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md) | 完整手动教程 |
| [DEPLOYMENT_DOCS_INDEX.md](./DEPLOYMENT_DOCS_INDEX.md) | 文档索引 |
| [scripts/README.md](./scripts/README.md) | 脚本目录说明 |

---

## 💡 温馨提示

1. ⚠️ **数据库密码**: 部署后立即修改数据库密码
2. 🔒 **SSH 安全**: 建议配置 SSH 密钥登录，禁用密码登录
3. 💾 **定期备份**: 设置定时任务自动备份数据
4. 🔄 **系统更新**: 定期更新系统和依赖包
5. 📊 **监控**: 建议配置服务器监控（CPU、内存、磁盘）
6. 🔐 **HTTPS**: 始终使用 HTTPS 访问，保护用户数据
7. 📝 **日志**: 定期检查日志，及时发现问题

---

## ✅ 部署完成检查清单

- [ ] 域名 DNS 已配置并生效
- [ ] AWS 安全组已配置正确的端口
- [ ] SSL 证书已成功获取
- [ ] 网站可以通过 HTTPS 访问
- [ ] 所有 PM2 进程正常运行
- [ ] Nginx 运行正常
- [ ] 数据库连接正常
- [ ] 环境变量已正确配置
- [ ] AI 聊天功能正常
- [ ] 表单提交功能正常
- [ ] 所有页面可以正常访问
- [ ] 已设置定时备份

---

## 🎉 恭喜！

如果所有步骤都完成了，你的 Nextmile 项目现在已经成功部署到新服务器了！

**访问你的网站**: https://你的域名.com

**下一步**:
1. 自定义网站内容
2. 配置 AI 功能
3. 优化性能
4. 添加监控
5. 邀请用户使用

需要帮助？查看详细文档或在 GitHub 提 Issue！

---

**祝你使用愉快！** 🚀
